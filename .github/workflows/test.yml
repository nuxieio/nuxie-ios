name: Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit:
    name: Unit (iOS)
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .xcode-spm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Pick iOS Simulator destination
        id: sim
        shell: bash
        run: |
          set -euo pipefail
          DESTINATION="$(python3 - <<'PY'
          import json
          import re
          import subprocess
          import sys

          data = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"]))
          devices_by_runtime = data.get("devices", {})

          def runtime_version(runtime_id: str):
            match = re.search(r"iOS-(\d+)-(\d+)", runtime_id)
            if match:
              return (int(match.group(1)), int(match.group(2)))
            match = re.search(r"iOS-(\d+)", runtime_id)
            if match:
              return (int(match.group(1)), 0)
            return (-1, -1)

          runtimes = sorted(
            (r for r in devices_by_runtime.keys() if "iOS" in r),
            key=runtime_version,
            reverse=True,
          )

          for runtime in runtimes:
            for device in devices_by_runtime.get(runtime, []):
              if not device.get("isAvailable"):
                continue
              name = device.get("name") or ""
              if "iPhone" not in name:
                continue
              udid = device.get("udid")
              if udid:
                print(f"platform=iOS Simulator,id={udid}")
                sys.exit(0)

          print("No available iPhone simulator found", file=sys.stderr)
          sys.exit(1)
          PY
          )"
          echo "destination=$DESTINATION" >> "$GITHUB_OUTPUT"

      - name: Run Unit Tests on iOS Simulator
        run: |
          COVERAGE=NO
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            COVERAGE=YES
          fi

          xcodebuild test \
            -project NuxieSDK.xcodeproj \
            -scheme NuxieSDKUnitTests \
            -destination '${{ steps.sim.outputs.destination }}' \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .xcode-spm \
            -resultBundlePath UnitTestResults.xcresult \
            -enableCodeCoverage "$COVERAGE"

      - name: Upload Unit Test Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: UnitTestResults.xcresult

  integration:
    name: Integration (iOS)
    if: github.event_name != 'pull_request'
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .xcode-spm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Pick iOS Simulator destination
        id: sim
        shell: bash
        run: |
          set -euo pipefail
          DESTINATION="$(python3 - <<'PY'
          import json
          import re
          import subprocess
          import sys

          data = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"]))
          devices_by_runtime = data.get("devices", {})

          def runtime_version(runtime_id: str):
            match = re.search(r"iOS-(\d+)-(\d+)", runtime_id)
            if match:
              return (int(match.group(1)), int(match.group(2)))
            match = re.search(r"iOS-(\d+)", runtime_id)
            if match:
              return (int(match.group(1)), 0)
            return (-1, -1)

          runtimes = sorted(
            (r for r in devices_by_runtime.keys() if "iOS" in r),
            key=runtime_version,
            reverse=True,
          )

          for runtime in runtimes:
            for device in devices_by_runtime.get(runtime, []):
              if not device.get("isAvailable"):
                continue
              name = device.get("name") or ""
              if "iPhone" not in name:
                continue
              udid = device.get("udid")
              if udid:
                print(f"platform=iOS Simulator,id={udid}")
                sys.exit(0)

          print("No available iPhone simulator found", file=sys.stderr)
          sys.exit(1)
          PY
          )"
          echo "destination=$DESTINATION" >> "$GITHUB_OUTPUT"

      - name: Run Integration Tests on iOS Simulator
        run: |
          xcodebuild test \
            -project NuxieSDK.xcodeproj \
            -scheme NuxieSDKIntegrationTests \
            -destination '${{ steps.sim.outputs.destination }}' \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .xcode-spm \
            -resultBundlePath IntegrationTestResults.xcresult \
            -enableCodeCoverage NO

      - name: Upload Integration Test Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: IntegrationTestResults.xcresult

  e2e:
    name: E2E (iOS)
    if: github.event_name != 'pull_request'
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .xcode-spm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Pick iOS Simulator destination
        id: sim
        shell: bash
        run: |
          set -euo pipefail
          DESTINATION="$(python3 - <<'PY'
          import json
          import re
          import subprocess
          import sys

          data = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "devices", "available", "-j"]))
          devices_by_runtime = data.get("devices", {})

          def runtime_version(runtime_id: str):
            match = re.search(r"iOS-(\d+)-(\d+)", runtime_id)
            if match:
              return (int(match.group(1)), int(match.group(2)))
            match = re.search(r"iOS-(\d+)", runtime_id)
            if match:
              return (int(match.group(1)), 0)
            return (-1, -1)

          runtimes = sorted(
            (r for r in devices_by_runtime.keys() if "iOS" in r),
            key=runtime_version,
            reverse=True,
          )

          for runtime in runtimes:
            for device in devices_by_runtime.get(runtime, []):
              if not device.get("isAvailable"):
                continue
              name = device.get("name") or ""
              if "iPhone" not in name:
                continue
              udid = device.get("udid")
              if udid:
                print(f"platform=iOS Simulator,id={udid}")
                sys.exit(0)

          print("No available iPhone simulator found", file=sys.stderr)
          sys.exit(1)
          PY
          )"
          echo "destination=$DESTINATION" >> "$GITHUB_OUTPUT"

      - name: Run E2E Tests on iOS Simulator
        env:
          NUXIE_E2E_PHASE1: "1"
          NUXIE_E2E_PHASE2: "1"
        run: |
          xcodebuild test \
            -project NuxieSDK.xcodeproj \
            -scheme NuxieSDKE2ETests \
            -destination '${{ steps.sim.outputs.destination }}' \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath .xcode-spm \
            -resultBundlePath E2ETestResults.xcresult \
            -enableCodeCoverage NO

      - name: Upload E2E Test Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: E2ETestResults.xcresult
